# Урок №6 - JPQL, Spring ORM, DAO на основе Spring ORM + JPA

# Домашнее задание

## Использовать ORM в качестве способа доступа к данным в приложении для хранения книг в библиотеке

## Цель: Закрепление материала прошедших лекций

- проектирование доменных сущностей;
- ООП;
- паттерн DAO/Repository;
- встроенная БД H2;
- JPA;
- Hibernate;
- решение типовых проблем при работе с БД и ORM;
- интеграционное тестирование репозиториев с помощью @DataJpaTest.

### Результат: Приложение на Spring ORM, JPA, Hibernate с интеграционными тестами

## Описание/Пошаговая инструкция выполнения домашнего задания

### <i><u>Задание:</u></i>

Перевести приложение каталог книг в библиотеке на репозитории, использующие в качестве технологии доступа к данным,
Spring ORM, JPA и Hibernate. Дополнить доменную модель сущностью комментария к книге.
Задание выполняется на базе предыдущей работы, но также имеет заготовку, содержащую тесты,
проверяющие некоторые из требований к заданию. Решение должно удовлетворять нижеуказанным требованиям.

#### <i><u>Требования к использованию заготовки:</u></i>

- Тесты из заготовки должны остаться неизменными (за исключением, возможно, имени пакета)

#### <i><u>Требования к реализации:</u></i>

- Использовать Spring ORM, JPA и Hibernate (EntityManager) в качестве технологии доступа к данным;
- Spring Data пока использовать нельзя;
- Добавить сущность "комментария к книге" (много комментариев к одной книге);
- Реализовать CRUD операции для новой сущности. Получение всех комментариев делать не нужно.
  Только конкретного комментария по id и всех комментариев по конкретной книге по ее id;
- Загрузка связей сущностей не должна приводить к большому количеству запросов к БД
  или избыточному по объему набору данных (проблема N+1 и проблема произведения таблиц);
- DDL через Hibernate должно быть отключено;
- LAZY-связи не должны присутствовать в equals/hashCode/toString. В т.ч. за счет @Data;
- Проблема N+1 должна быть решена теми же способами, что и в прошлой работе, но уже через инструменты
  предоставляемыми ORM;
- Аннотация @Transactional должна присутствовать только на методах сервиса;
- Покрыть все репозитории тестами, используя H2 базу данных и @DataJpaTest;
- В тестах репозиториев, для проверки или подготовки данных использовать TestEntityManager
  (только методы, не требующие написания запросов). Сами репозитории для этого использовать нельзя;
- Написать интеграционные тесты сервисов книг и комментариев, где проверить, что доступ к связям,
  которые используются снаружи сервисов, не вызывают LazyInitializationException;
- Не забыть учесть в тестах, что тестовый контекст кэшируется, т.е. должны проходить как все тесты разом,
  так и по отдельности;
- Для приема работы тесты из заготовки должны проходить;
- Без фанатизма.

Заготовка для выполнения работы: https://github.com/OtusTeam/Spring/tree/master/templates/hw06-jpa

Задание сдаётся только после приема предыдущей работы.

Задание сдаётся в виде ссылки на pull-request в чат с преподавателем в личном кабинете ОТУС, а не в Telegram.

В pull-request должно присутствовать только то, что касается текущей работы.
Временные файлы и файлы IDE не должны попадать в PR.
