<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta content="IE=edge,chrome=1; charset=UTF-8" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.8/css/bootstrap.min.css}">
    <title>Clients Management</title>
    <style>
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .table-container {
            min-height: 400px;
        }
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Управление клиентами</h1>
                <div class="d-flex gap-2">
                    <a href="/profile" class="btn btn-outline-primary">Мой профиль</a>
                    <form th:action="@{/logout}" method="post" class="d-inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-outline-secondary">Выход</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="messageContainer"></div>

    <div class="card mb-3">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">Show</span>
                        <select class="form-select" id="pageSizeSelect">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                        <span class="input-group-text">entries</span>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-secondary" onclick="loadClients()">
                        <i class="fas fa-sync-alt"></i> Актуализировать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Клиенты</h5>
        </div>
        <div class="card-body">
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Загрузка клиентской базы...</p>
            </div>

            <div id="tableContainer" class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Company Name</th>
                            <th>Is Supplier</th>
                            <th>Company Folder</th>
                            <th>Price List Way</th>
                            <th>Price List Format</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="text-center text-muted py-4" style="display: none;">
                    Клиенты не найдены
                </div>
            </div>

            <div class="pagination-container">
                <div id="pageInfo" class="text-muted">
                    Показано 0 из 0 клиентов
                </div>
                <nav id="paginationNav" aria-label="Clients pagination" style="display: none;">
                    <ul class="pagination justify-content-center mb-0" id="paginationList">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Подтвердите удаление</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Вы уверены, что хотите удалить клиент <strong id="clientToDelete"></strong>?
                Это действие не может быть отменено.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отменить</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 0;
    let pageSize = 10;
    let totalPages = 0;
    let totalElements = 0;

    document.addEventListener('DOMContentLoaded', function() {
        loadClients();

        document.getElementById('pageSizeSelect').addEventListener('change', function() {
            pageSize = parseInt(this.value);
            currentPage = 0;
            loadClients();
        });
    });

    async function loadClients() {
        showLoading();

        try {
            const response = await fetch(`/api/v1/client?page=${currentPage}&size=${pageSize}`, {
                headers: {
                    'Authorization': 'Bearer ' + getAccessTokenFromCookie()
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            renderClientsTable(data);

        } catch (error) {
            console.error('Ошибка при загрузке клиентов:', error);
            showMessage('Не удалось загрузить клиентов: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    }

    function renderClientsTable(pageData) {
        const clients = pageData.content;
        totalPages = pageData.totalPages;
        totalElements = pageData.totalElements;

        const tableBody = document.getElementById('clientsTableBody');
        const emptyState = document.getElementById('emptyState');

        tableBody.innerHTML = '';

        if (clients.length === 0) {
            emptyState.style.display = 'block';
            document.getElementById('paginationNav').style.display = 'none';
            updatePageInfo(0, totalElements);
            return;
        }

        emptyState.style.display = 'none';

        clients.forEach(client => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${escapeHtml(client.username)}</td>
                <td>${escapeHtml(client.email)}</td>
                <td>${escapeHtml(client.name || '')}</td>
                <td>${escapeHtml(client.companyName)}</td>
                <td>
                    <span class="badge ${client.isSupplier ? 'bg-success' : 'bg-secondary'}">
                        ${client.isSupplier ? 'Да' : 'Нет'}
                    </span>
                </td>
                <td>${escapeHtml(client.companyFolder || '')}</td>
                <td>
                    <span class="badge bg-info text-dark">${client.pricelistObtainingWay}</span>
                </td>
                <td>
                    <span class="badge bg-light text-dark">${client.pricelistFormat}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="/profile-edit?username=${encodeURIComponent(client.username)}"
                           class="btn btn-outline-primary">Edit</a>
                        <button type="button"
                                class="btn btn-outline-danger"
                                onclick="confirmDelete('${escapeHtml(client.username)}')">
                            Delete
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });

        renderPagination();
        updatePageInfo(clients.length, totalElements);
    }

    function renderPagination() {
        const paginationList = document.getElementById('paginationList');
        paginationList.innerHTML = '';

        if (totalPages <= 1) {
            document.getElementById('paginationNav').style.display = 'none';
            return;
        }

        document.getElementById('paginationNav').style.display = 'block';

        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        `;
        paginationList.appendChild(prevLi);

        for (let i = 0; i < totalPages; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a>
            `;
            paginationList.appendChild(pageLi);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        `;
        paginationList.appendChild(nextLi);
    }

    function changePage(newPage) {
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadClients();
        }
    }

    function updatePageInfo(shown, total) {
        document.getElementById('pageInfo').textContent =
            `Showing ${shown} of ${total} clients`;
    }

    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('tableContainer').style.opacity = '0.5';
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('tableContainer').style.opacity = '1';
    }

    function showMessage(message, type) {
        const messageContainer = document.getElementById('messageContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        messageContainer.appendChild(alert);

        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    let clientToDelete = '';

    function confirmDelete(username) {
        clientToDelete = username;
        document.getElementById('clientToDelete').textContent = username;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        try {
            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            const response = await fetch('/api/v1/client/' + encodeURIComponent(clientToDelete), {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + getAccessTokenFromCookie(),
                    'X-CSRF-TOKEN': csrfToken
                }
            });

            if (response.ok) {
                showMessage('Клиент успешно удален', 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                await loadClients();
            } else {
                const error = await response.text();
                throw new Error(error || 'Не удалось удалить клиент');
            }
        } catch (err) {
            console.error('Ошибка удаления:', err);
            showMessage('Не удалось удалить клиент: ' + err.message, 'danger');
        }
    });

    function getAccessTokenFromCookie() {
        const name = 'access-token';
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return unsafe
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
<script th:src="@{/webjars/bootstrap/5.3.8/js/bootstrap.bundle.min.js}"></script>
</body>
</html>