<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta content="IE=edge,chrome=1; charset=UTF-8" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.8/css/bootstrap.min.css}">
    <title>Price List Files</title>
    <style>
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .table-container {
            min-height: 400px;
        }
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #0d6efd;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .file-size {
            color: #6c757d;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Price List Files</h1>
                <div class="d-flex gap-2">
                    <a href="/profile" class="btn btn-outline-primary">My Profile</a>
                    <form th:action="@{/logout}" method="post" class="d-inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-outline-secondary">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messageContainer"></div>

    <!-- Upload Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Upload Price List</h5>
        </div>
        <div class="card-body">
            <div id="uploadArea" class="upload-area">
                <div id="uploadContent">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Drag and drop your file here</h5>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.json,.xml,.txt" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        Select File
                    </button>
                </div>
                <div id="uploadProgress" style="display: none;">
                    <div class="progress mb-3">
                        <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="uploadStatus">Uploading...</p>
                    <button type="button" class="btn btn-secondary" onclick="cancelUpload()">Cancel</button>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    Allowed formats: XLSX, XLS, CSV, JSON, XML, TXT. Maximum file size: 20MB.
                    <code id="companyFolder" th:text="${companyFolder}" th:data-company-folder="${companyFolder}">company-folder</code>
                </small>
            </div>
        </div>
    </div>

    <!-- Files Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Uploaded Files</h5>
        </div>
        <div class="card-body">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading files...</p>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>File Name</th>
                            <th>Upload Date</th>
                            <th>Size</th>
                            <th>Path</th>
                        </tr>
                        </thead>
                        <tbody id="filesTableBody">
                        <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center text-muted py-4" style="display: none;">
                    No files uploaded yet
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div id="pageInfo" class="text-muted">
                    Showing 0 of 0 files
                </div>
                <nav id="paginationNav" aria-label="Files pagination" style="display: none;">
                    <ul class="pagination justify-content-center mb-0" id="paginationList">
                        <!-- Pagination will be populated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 0;
    let pageSize = 10;
    let totalPages = 0;
    let totalElements = 0;
    let currentUploadController = null;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadFiles();
        setupUploadArea();
    });

    function setupUploadArea() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // File input change handler
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFileSelect(this.files[0]);
            }
        });

        // Click to open file dialog
        uploadArea.addEventListener('click', function(e) {
            if (e.target.id !== 'fileInput' && e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });
    }

    function handleFileSelect(file) {
        // Basic validation
        if (!file) return;

        const maxSize = 20 * 1024 * 1024; // 20MB
        if (file.size > maxSize) {
            showMessage('File size exceeds 20MB limit', 'danger');
            return;
        }

        const allowedExtensions = ['.xlsx', '.xls', '.csv', '.json', '.xml', '.txt'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(fileExtension)) {
            showMessage('File type not allowed. Allowed types: ' + allowedExtensions.join(', '), 'danger');
            return;
        }

        uploadFile(file);
    }

    async function uploadFile(file) {
        const uploadContent = document.getElementById('uploadContent');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadStatus = document.getElementById('uploadStatus');

        // Show progress UI
        uploadContent.style.display = 'none';
        uploadProgress.style.display = 'block';
        uploadProgressBar.style.width = '0%';
        uploadStatus.textContent = 'Uploading...';

        try {
            const formData = new FormData();
            formData.append('file', file);
            const companyFolder = document.getElementById('companyFolder').getAttribute('data-company-folder');
            const folderInput = document.getElementById('companyFolder');
            if (!folderInput) {
                showMessage('Configuration error: company folder not found', 'danger');
                return;
            }
            formData.append('companyFolder', companyFolder);

            // Create AbortController for cancel functionality
            currentUploadController = new AbortController();

            const response = await fetch('/api/v1/client/files/upload', {
                method: 'POST',
                body: formData,
                signal: currentUploadController.signal,
                headers: {
                    'Authorization': 'Bearer ' + getAccessTokenFromCookie(),
                    'X-CSRF-TOKEN': getCsrfToken()
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `Upload failed with status: ${response.status}`);
            }

            const result = await response.json();
            showMessage('File uploaded successfully: ' + result.originalFileName, 'success');

            // Reset upload UI
            uploadContent.style.display = 'block';
            uploadProgress.style.display = 'none';
            document.getElementById('fileInput').value = '';

            // Reload files list
            loadFiles();

        } catch (error) {
            if (error.name === 'AbortError') {
                showMessage('Upload cancelled', 'warning');
            } else {
                console.error('Upload error:', error);
                showMessage('Upload failed: ' + error.message, 'danger');
            }
            // Reset upload UI
            uploadContent.style.display = 'block';
            uploadProgress.style.display = 'none';
        } finally {
            currentUploadController = null;
        }
    }

    function cancelUpload() {
        if (currentUploadController) {
            currentUploadController.abort();
        }
    }

    async function loadFiles() {
        showLoading();

        try {
            const response = await fetch(`/api/v1/client/files?page=${currentPage}&size=${pageSize}`, {
                headers: {
                    'Authorization': 'Bearer ' + getAccessTokenFromCookie()
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            renderFilesTable(data);

        } catch (error) {
            console.error('Error loading files:', error);
            showMessage('Failed to load files: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    }

    function renderFilesTable(pageData) {
        const files = pageData.content;
        totalPages = pageData.totalPages;
        totalElements = pageData.totalElements;

        const tableBody = document.getElementById('filesTableBody');
        const emptyState = document.getElementById('emptyState');

        // Clear table
        tableBody.innerHTML = '';

        if (files.length === 0) {
            emptyState.style.display = 'block';
            document.getElementById('paginationNav').style.display = 'none';
            updatePageInfo(0, totalElements);
            return;
        }

        emptyState.style.display = 'none';

        // Populate table rows
        files.forEach(file => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${escapeHtml(file.originalFileName)}</td>
                <td>${new Date(file.uploadDate).toLocaleString()}</td>
                <td><span class="file-size">${file.formattedFileSize}</span></td>
                <td><code>${escapeHtml(file.filePath)}</code></td>
            `;
            tableBody.appendChild(row);
        });

        renderPagination();
        updatePageInfo(files.length, totalElements);
    }

    function renderPagination() {
        const paginationList = document.getElementById('paginationList');
        paginationList.innerHTML = '';

        if (totalPages <= 1) {
            document.getElementById('paginationNav').style.display = 'none';
            return;
        }

        document.getElementById('paginationNav').style.display = 'block';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        `;
        paginationList.appendChild(prevLi);

        // Page numbers
        for (let i = 0; i < totalPages; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a>
            `;
            paginationList.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        `;
        paginationList.appendChild(nextLi);
    }

    function changePage(newPage) {
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadFiles();
        }
    }

    function updatePageInfo(shown, total) {
        document.getElementById('pageInfo').textContent =
            `Showing ${shown} of ${total} files`;
    }

    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('tableContainer').style.opacity = '0.5';
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('tableContainer').style.opacity = '1';
    }

    function showMessage(message, type) {
        const messageContainer = document.getElementById('messageContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        messageContainer.appendChild(alert);

        // Auto remove after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    // Utility functions
    function getAccessTokenFromCookie() {
        const name = 'access-token';
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function getCsrfToken() {
        return document.querySelector('input[name="_csrf"]').value;
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return unsafe
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
<script th:src="@{/webjars/bootstrap/5.3.8/js/bootstrap.bundle.min.js}"></script>
</body>
</html>